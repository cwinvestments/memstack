# Session Diary — DocStack — 2026-02-19

## Accomplished
- Built full-text search API with PostgreSQL tsvector + ts_headline highlighting
- Created search RPC functions (search_pages, search_pages_count) in migration 004
- Built search page with 300ms debounce, collection filter, highlighted snippets, pagination
- Built entity browser page with type tabs (All, People, Emails, Phones, Dates) and click-to-search
- Created entities API route with type filtering and per-type counts
- Added XSS sanitization for ts_headline output (strips all HTML except mark tags)

## Files Changed
- supabase/migrations/004_search_function.sql — RPC functions for full-text search with highlighting
- src/app/api/search/route.ts — Search API with parallel query+count, search logging
- src/app/api/entities/route.ts — Entities API with type filtering and counts
- src/app/(dashboard)/dashboard/search/page.tsx — Search UI with debounce, filters, highlighted results
- src/app/(dashboard)/dashboard/entities/page.tsx — Entity browser with type tabs, color coding

## Session 2: Admin Panel & Settings

### Accomplished
- Built admin panel at /dashboard/admin with platform-wide stats cards and users table
- Created 3 admin API routes: stats, users list (with search/pagination), user detail+update
- Admin user detail modal: view collections, change role (user/admin), change plan (free/pro/enterprise)
- Built settings page at /dashboard/settings: account info, plan display, usage progress bars, password change
- Updated sidebar: admin link with shield icon (visible only to role=admin, amber highlight)
- Updated middleware: gate /dashboard/admin routes with admin role check

### Files Changed
- src/app/api/admin/stats/route.ts — Platform stats (6 parallel queries via admin client)
- src/app/api/admin/users/route.ts — User list with search/pagination
- src/app/api/admin/users/[id]/route.ts — User detail GET + role/plan update PUT
- src/app/(dashboard)/dashboard/admin/page.tsx — Admin dashboard with stats + user table + detail modal
- src/app/(dashboard)/dashboard/settings/page.tsx — Settings with usage bars + password change
- src/app/(dashboard)/layout.tsx — Added conditional admin nav item
- src/middleware.ts — Added /dashboard/admin to admin route gate

## Session 3: Stripe Billing Integration

### Accomplished
- Installed stripe SDK, created src/lib/stripe.ts with lazy init + checkout/portal/status helpers
- Created checkout API route: maps plan to Stripe price ID, creates hosted checkout session with user metadata
- Created billing portal API route: opens Stripe portal for existing subscribers
- Created webhook handler: checkout.session.completed, subscription.updated, subscription.deleted
- Migration 005: added stripe_customer_id and stripe_subscription_id columns to users table
- Updated settings page: upgrade plan cards (Pro/Enterprise) with feature lists, manage subscription button, billing redirect messages

### Files Changed
- src/lib/stripe.ts — Stripe client with lazy init, checkout session, billing portal, subscription status
- src/app/api/billing/checkout/route.ts — POST to create Stripe Checkout session for plan upgrade
- src/app/api/billing/portal/route.ts — POST to create Stripe billing portal session
- src/app/api/webhooks/stripe/route.ts — Webhook handler with signature verification
- supabase/migrations/005_stripe_columns.sql — stripe_customer_id + stripe_subscription_id columns
- src/app/(dashboard)/dashboard/settings/page.tsx — Upgrade plan cards + manage subscription
- .env.local.example — Added 5 Stripe env vars
- package.json — Added stripe dependency

## Session 4: Marketing Landing Page & Deployment

### Accomplished
- Built marketing landing page at / with hero, features grid (6 cards), pricing section (3 plans), footer
- Created (marketing) route group with minimal navbar layout (logo + login/signup, no sidebar)
- Deleted default Next.js starter page, updated root layout metadata
- Created netlify.toml with Next.js plugin, Node 20, build config
- Updated CLAUDE.md with deployment section, public pages list, URL placeholder

### Files Changed
- src/app/(marketing)/layout.tsx — Navbar-only layout for public pages
- src/app/(marketing)/page.tsx — Landing page with hero, features, pricing, footer
- src/app/page.tsx — Deleted (replaced by marketing route group)
- src/app/layout.tsx — Updated metadata title and description
- netlify.toml — Netlify deployment config
- CLAUDE.md — Added deployment, public pages, URL sections

## Commits
- d961a79 [DocStack] Add full-text search with highlighting and entity browser
- 114f479 [DocStack] Add admin panel, user management, and settings page
- 9669bf5 [DocStack] Add Stripe billing with checkout, webhooks, and plan management
- ee15144 [DocStack] Add marketing landing page and Netlify deployment config

## Decisions
- Used websearch_to_tsquery instead of to_tsquery: handles natural language queries without & operators
- Created SECURITY DEFINER RPC functions: allows cross-table joins bypassing RLS while API validates user_id
- Sanitize ts_headline HTML client-side: strip all tags except mark to prevent XSS from OCR content
- Entity click-to-search: clicking an entity navigates to /dashboard/search?q={value} for seamless UX
- Admin panel at /dashboard/admin (not /admin): keeps all dashboard routes under /dashboard/* for consistency
- Middleware updated to gate both /admin and /dashboard/admin paths
- Admin nav uses amber (#f59e0b) highlight instead of teal to distinguish from regular nav
- Password change verifies current password via signInWithPassword before updating
- All admin API routes use getSupabaseAdmin() to bypass RLS for platform-wide queries
- Stripe: CheckoutSessions API (Stripe-hosted) over PaymentIntents per Stripe best practices for SaaS
- Stripe: metadata.user_id on checkout+subscription bridges Stripe events back to DocStack user IDs
- Stripe: webhook reads raw body via request.text() for signature verification (parsed JSON breaks HMAC)
- Stripe: webhook returns 200 even on handler errors to prevent infinite retries for bugs

## Problems and Solutions
- React 19 useRef requires initial value: useRef with generic type needs undefined passed explicitly
- Security hook blocked raw HTML rendering: added sanitizeHeadline() that only allows mark tags
- Admin route at /dashboard/admin not caught by existing /admin middleware check: added /dashboard/admin to the condition
- Stripe SDK v17+ removed Subscription.current_period_end from top-level type: removed from helper return type

## Next Steps
- Deploy to Netlify (connect repo, set env vars, test webhook)
- Collection sharing (public/private links)
- Usage analytics charts (searches per day, docs uploaded per day)
- OCR queue management (retry failed jobs)
- API key generation for Pro/Enterprise users
